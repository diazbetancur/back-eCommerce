# ??? Arquitectura Final del Sistema Multi-Tenant

## ?? Diagrama de Arquitectura Completo

```
???????????????????????????????????????????????????????????????????????????
?                         CLIENTE (Frontend)                               ?
?                                                                          ?
?  ??????????????????              ??????????????????????????????????    ?
?  ?  Admin Panel   ?              ?    Tienda del Tenant           ?    ?
?  ?  (Global)      ?              ?    (mi-tienda.com)             ?    ?
?  ??????????????????              ??????????????????????????????????    ?
?????????????????????????????????????????????????????????????????????????
            ?                                     ?
            ? NO Header                           ? Header: X-Tenant-Slug: mi-tienda
            ?                                     ?
??????????????????????????????????????????????????????????????????????????
?                       API GATEWAY (.NET 8)                              ?
?                       Program.cs + Middlewares                          ?
?                                                                          ?
?  ????????????????????????????????????????????????????????????????????  ?
?  ?  Routing Logic                                                    ?  ?
?  ?                                                                   ?  ?
?  ?  /admin/*        ? NO requiere X-Tenant-Slug                     ?  ?
?  ?  /provision/*    ? NO requiere X-Tenant-Slug                     ?  ?
?  ?  /superadmin/*   ? NO requiere X-Tenant-Slug                     ?  ?
?  ?  /health         ? NO requiere X-Tenant-Slug                     ?  ?
?  ?                                                                   ?  ?
?  ?  /auth/*         ? REQUIERE X-Tenant-Slug                        ?  ?
?  ?  /products/*     ? REQUIERE X-Tenant-Slug                        ?  ?
?  ?  /cart/*         ? REQUIERE X-Tenant-Slug                        ?  ?
?  ?  /orders/*       ? REQUIERE X-Tenant-Slug                        ?  ?
?  ????????????????????????????????????????????????????????????????????  ?
?????????????????????????????????????????????????????????????????????????
              ?                                    ?
              ?                                    ?
??????????????????????????????      ????????????????????????????????????
?   AdminDbContext           ?      ?   TenantDbContext (Dinámico)     ?
?   (Singleton Connection)   ?      ?   (Scoped per Request)           ?
?                            ?      ?                                   ?
?   ConnectionString:        ?      ?   ConnectionString:               ?
?   "AdminDb"                ?      ?   Tenancy:TenantDbTemplate        ?
?                            ?      ?   ? Database={DbName}             ?
??????????????????????????????      ?????????????????????????????????????
             ?                                    ?
             ?                                    ?
???????????????????????????????????  ????????????????????????????????????
?   PostgreSQL - AdminDb          ?  ?  PostgreSQL - TenantDb_{slug}    ?
?   (ecommerce_admin)             ?  ?                                   ?
?                                 ?  ?  ????????????????????????????    ?
?  Tables:                        ?  ?  ? tenant_mi-tienda         ?    ?
?  ??? admin.Tenants              ?  ?  ? ??? TenantUsers          ?    ?
?  ??? admin.Plans                ?  ?  ? ??? TenantRoles          ?    ?
?  ??? admin.AdminUsers           ?  ?  ? ??? TenantUserRoles     ?    ?
?  ??? admin.AdminRoles           ?  ?  ? ??? Products             ?    ?
?  ??? admin.AdminUserRoles       ?  ?  ? ??? Orders               ?    ?
?  ??? admin.TenantProvisionings  ?  ?  ? ??? Customers            ?    ?
?  ??? admin.Features             ?  ?  ? ??? Cart                 ?    ?
?  ??? admin.PlanFeatures         ?  ?  ? ??? LoyaltyAccounts      ?    ?
?                                 ?  ?  ????????????????????????????    ?
?  Usuarios:                      ?  ?                                   ?
?  - admin@yourdomain.com         ?  ?  ????????????????????????????    ?
?    (SuperAdmin)                 ?  ?  ? tenant_otra-tienda       ?    ?
?                                 ?  ?  ? ??? TenantUsers          ?    ?
?  Tenants:                       ?  ?  ? ??? Products             ?    ?
?  - mi-tienda (Ready)            ?  ?  ? ??? ...                  ?    ?
?  - otra-tienda (Ready)          ?  ?  ????????????????????????????    ?
?  - test-store (Pending)         ?  ?                                   ?
???????????????????????????????????  ?????????????????????????????????????
```

---

## ?? Flujo de Autenticación

### **1. Login Admin Global (SuperAdmin)**

```
Cliente (Admin Panel)
  ?
  ??? POST /admin/auth/login
  ?   Body: { email, password }
  ?   Headers: (ninguno)
  ?
  ??? AdminAuthService
  ?   ?
  ?   ??? AdminDbContext
  ?   ?   ??? SELECT * FROM admin.AdminUsers WHERE email = ?
  ?   ?
  ?   ??? Verify Password (PBKDF2)
  ?   ?
  ?   ??? Generate JWT
  ?       Claims:
  ?       - sub: userId
  ?       - email: admin@yourdomain.com
  ?       - admin: "true" ?
  ?       - role: "SuperAdmin"
  ?
  ??? Response: { token, user }
```

### **2. Login Usuario del Tenant**

```
Cliente (Tienda)
  ?
  ??? POST /auth/login
  ?   Body: { email, password }
  ?   Headers: X-Tenant-Slug: mi-tienda ?
  ?
  ??? TenantResolutionMiddleware
  ?   ?
  ?   ??? AdminDbContext
  ?   ?   ??? SELECT * FROM admin.Tenants WHERE slug = 'mi-tienda'
  ?   ?   ??? Get ConnectionString
  ?   ?
  ?   ??? TenantAccessor.SetTenant(...)
  ?
  ??? AuthService
  ?   ?
  ?   ??? TenantDbContext (tenant_mi-tienda)
  ?   ?   ??? SELECT * FROM TenantUsers WHERE email = ?
  ?   ?
  ?   ??? Verify Password
  ?   ?
  ?   ??? Generate JWT
  ?       Claims:
  ?       - sub: userId
  ?       - email: user@mi-tienda.com
  ?       - tenant_id: guid ?
  ?       - tenant_slug: "mi-tienda" ?
  ?       - role: "Customer" ? (FALTA IMPLEMENTAR)
  ?
  ??? Response: { token, user }
```

---

## ??? Flujo de Requests con Tenant

### **Request a Endpoint de Tenant**

```
GET /products?category=electronics
Headers: 
  - X-Tenant-Slug: mi-tienda
  - Authorization: Bearer {token}

???????????????????????????????????
? 1. TenantResolutionMiddleware  ?
?    ?? Leer X-Tenant-Slug        ?
?    ?? Buscar tenant en AdminDb  ?
?    ?? Validar status = Ready    ?
?    ?? Crear connection string   ?
???????????????????????????????????
               ?
???????????????????????????????????
? 2. TenantDbContextFactory       ?
?    ?? Create(connectionString)  ?
???????????????????????????????????
               ?
???????????????????????????????????
? 3. CatalogService               ?
?    ?? GetProductsAsync()        ?
???????????????????????????????????
               ?
???????????????????????????????????
? 4. TenantDbContext              ?
?    (tenant_mi-tienda)           ?
?    ?? SELECT * FROM Products    ?
?       WHERE category = ?        ?
???????????????????????????????????
               ?
               ?
          Response JSON
```

---

## ?? Capas de la Aplicación

```
?????????????????????????????????????????????????????????????
?                    Api-eCommerce                          ?
?  (Presentation Layer)                                     ?
?                                                           ?
?  ??? Endpoints/                                           ?
?  ?   ??? AdminEndpoints.cs       (NO Tenant)             ?
?  ?   ??? ProvisioningEndpoints.cs (NO Tenant)            ?
?  ?   ??? TenantAuthEndpoints.cs  (Requiere Tenant)       ?
?  ?   ??? CatalogEndpoints.cs     (Requiere Tenant)       ?
?  ?   ??? ...                                              ?
?  ?                                                         ?
?  ??? Middleware/                                          ?
?  ?   ??? TenantResolutionMiddleware.cs ?                ?
?  ?   ??? MeteringMiddleware.cs                           ?
?  ?   ??? ErrorHandlingMiddleware.cs                      ?
?  ?                                                         ?
?  ??? Program.cs (DI Configuration)                        ?
?????????????????????????????????????????????????????????????
                         ?
                         ?
?????????????????????????????????????????????????????????????
?                   CC.Aplication                           ?
?  (Application Layer)                                      ?
?                                                           ?
?  ??? Admin/                                               ?
?  ?   ??? AdminAuthService.cs     (AdminDb)               ?
?  ?   ??? AdminTenantService.cs   (AdminDb)               ?
?  ?   ??? DTOs/                                            ?
?  ?                                                         ?
?  ??? Auth/                                                ?
?  ?   ??? AuthService.cs          (TenantDb)              ?
?  ?                                                         ?
?  ??? Services/                                            ?
?  ?   ??? CatalogService.cs       (TenantDb)              ?
?  ?   ??? CartService.cs          (TenantDb)              ?
?  ?   ??? OrderService.cs         (TenantDb)              ?
?  ?   ??? FeatureService.cs       (AdminDb + TenantDb)    ?
?  ?                                                         ?
?  ??? Provisioning/                                        ?
?      ??? TenantProvisioner.cs    (AdminDb + Creates DBs) ?
?????????????????????????????????????????????????????????????
                         ?
                         ?
?????????????????????????????????????????????????????????????
?                CC.Infraestructure                         ?
?  (Infrastructure Layer)                                   ?
?                                                           ?
?  ??? AdminDb/                                             ?
?  ?   ??? AdminDbContext.cs       ?                       ?
?  ?                                                         ?
?  ??? Tenant/                                              ?
?  ?   ??? TenantDbContext.cs      ?                       ?
?  ?   ??? TenantDbContextFactory.cs ?                     ?
?  ?   ??? Entities/                                        ?
?  ?                                                         ?
?  ??? Tenancy/                                             ?
?  ?   ??? TenantAccessor.cs       ?                       ?
?  ?   ??? TenantResolver.cs       ?                       ?
?  ?   ??? TenantConnectionProtector.cs                    ?
?  ?                                                         ?
?  ??? Configurations/                                      ?
?      ??? DBContext.cs             ?? LEGACY              ?
?????????????????????????????????????????????????????????????
                         ?
                         ?
?????????????????????????????????????????????????????????????
?                     CC.Domain                             ?
?  (Domain Layer)                                           ?
?                                                           ?
?  ??? Entities/         (Domain Models)                    ?
?  ??? Tenancy/          (Tenant Domain Models)             ?
?  ??? Users/            (User Domain Models)               ?
?????????????????????????????????????????????????????????????
```

---

## ?? Configuración de Conexiones (Clean)

### **appsettings.json (Producción)**

```json
{
  "ConnectionStrings": {
    "AdminDb": "Host=...;Database=ecommerce_admin;...",
    "PgSQL": "Host=...;Database=eCommerce;..." // [LEGACY]
  },
  "Tenancy": {
    "TenantDbTemplate": "Host=...;Database={DbName};..."
    // ? Eliminado: "AdminDb" (duplicado)
  },
  "jwtKey": "production-secret-key"
}
```

### **appsettings.Development.json (Local)**

```json
{
  "ConnectionStrings": {
    "AdminDb": "Host=localhost;Database=ecommerce_admin;...",
    "PgSQL": "Host=localhost;Database=ecommerce_main;..." // [LEGACY]
  },
  "Tenancy": {
    "TenantDbTemplate": "Host=localhost;Database={DbName};..."
    // ? Eliminado: "AdminDb" (duplicado)
  },
  "jwtKey": "dev-secret-key"
}
```

---

## ?? Estado Actual del Sistema

### ? **Implementado y Funcionando**

| Componente | Estado |
|------------|--------|
| AdminDb + Migraciones | ? |
| TenantDb Template | ? |
| Provisioning Automático | ? |
| Admin Login (Global) | ? |
| Tenant Login | ? |
| Multi-Tenancy Middleware | ? |
| Feature Flags | ? |
| Catalog, Cart, Checkout | ? |

### ?? **Parcialmente Implementado**

| Componente | Estado | Falta |
|------------|--------|-------|
| Roles en TenantDb | ?? | TenantUserRole relación, JWT con roles |
| Admin del Tenant | ?? | Endpoints /admin/products, etc. |

### ? **Pendiente de Eliminar**

| Componente | Razón |
|------------|-------|
| DBContext (PgSQL) | Legacy Identity - Migrar a TenantDb |
| ConnectionStrings:PgSQL | Duplicado innecesario |

---

## ?? Próximos Pasos Recomendados

1. **FASE 1** (2-3 horas): Sistema de Roles en TenantDb
2. **FASE 2** (3-4 horas): Endpoints de Admin del Tenant
3. **FASE 3** (1-2 días): Migración de Identity y eliminación de legacy

**Ver**: `PLAN_IMPLEMENTACION.md` para detalles completos.

---

**Arquitectura**: Multi-Tenant Database-Per-Tenant  
**Estado**: ? Base sólida, configuración limpia  
**Listo para**: Implementación de Fase 1 (Roles)
